# ============ q2api 生产环境配置示例 ============
# 复制此文件为 .env 并填入真实值
#
# 最后更新: 2026-01-12
#
# 更新日志:
# - 2026-01-12: 全面修复 - 添加会话管理和数据库超时配置
#   * MAX_AUTH_SESSIONS: 10000 -> 1000 (降低内存占用90%)
#   * SESSION_TTL_SECONDS: 新增 (默认600秒)
#   * DATABASE_TIMEOUT: 新增 (默认30秒)
#   * SQLITE_MAX_CONNECTIONS: 新增 (默认10)
#
# Docker 构建加速: 国内服务器建议 true
USE_CN_MIRROR=true

# ============ 上游服务 URL 配置（必须配置）============

# OIDC 认证服务基础 URL
OIDC_BASE_URL="https://oidc.us-east-1.amazonaws.com"

# OIDC 登录起始 URL
OIDC_START_URL="https://view.awsapps.com/start"

# 号池服务地址 (用于一键获取号池账号)
POOL_SERVICE_URL=""

# Amazon Q 服务基础 URL
AMAZON_Q_BASE_URL="https://q.us-east-1.amazonaws.com"

# Amazon Q 服务路径（默认 /）
AMAZON_Q_PATH="/"

# Amazon Q 目标服务（一般无需修改）
AMAZON_Q_TARGET="AmazonCodeWhispererStreamingService.GenerateAssistantResponse"

# Amazon Q 默认模型
AMAZON_Q_DEFAULT_MODEL="claude-sonnet-4"

# Amazon Q User-Agent（一般无需修改）
AMAZON_Q_USER_AGENT="aws-sdk-rust/1.3.9 ua/2.1 api/codewhispererstreaming/0.1.11582 os/macos lang/rust/1.87.0 exec-env/CLI md/appVersion-1.19.7 app/AmazonQ-For-CLI"
AMAZON_Q_X_AMZ_USER_AGENT="aws-sdk-rust/1.3.9 ua/2.1 api/codewhispererstreaming/0.1.11582 os/macos lang/rust/1.87.0 exec-env/CLI m/F md/appVersion-1.19.7 app/AmazonQ-For-CLI"

# Amazon Q 数据收集选项（false = 允许收集）
AMAZON_Q_OPTOUT="false"

# Amazon Q 客户端环境状态
AMAZON_Q_CLIENT_OS="linux"
AMAZON_Q_CLIENT_CWD="/"

# ============ 主服务配置 ============

# 数据库连接URL（留空使用本地SQLite）
# 生产环境强烈建议使用PostgreSQL
# PostgreSQL: DATABASE_URL="postgres://user:password@host:5432/dbname?sslmode=require"
# MySQL: DATABASE_URL="mysql://user:password@host:3306/dbname"
DATABASE_URL=""

# ============ 高级安全配置 ============
SECURITY_LEVEL=production              # 安全级别: development, production, military

# ============ API密钥管理 ============
# 密钥现在存储在数据库中（secure_keys 表），不再使用环境变量
#
# 如何生成新密钥：
# 方法1: 使用初始化工具
#   python tools/init_keys.py
#
# 方法2: 通过管理 API 生成（推荐）
#   curl -X POST http://localhost:8000/v2/security/keys/generate \
#     -H "X-Admin-Key: YOUR_ADMIN_API_KEY" \
#     -H "Content-Type: application/json" \
#     -d '{"expires_in_days": 180}'
#
# 查看现有密钥：
#   sqlite3 data/database/data.sqlite3 "SELECT key_id, created_at, expires_at, status FROM secure_keys;"
#
# ⚠️  已废弃的配置（请勿使用）：
# OPENAI_KEYS=""  # 不再需要，密钥已迁移到数据库

# Token 计数倍率
# 有效范围: 0.1 - 10.0
TOKEN_COUNT_MULTIPLIER="1.0"

# 出错次数阈值，超过此值自动禁用账号
MAX_ERROR_COUNT=100

# ============ 会话管理配置（内存优化）============
# Major Fix (2026-01-12): 降低默认容量并添加TTL机制防止内存泄漏

# 最大认证会话数（防止内存泄漏）
# 降低从 10000 到 1000，减少内存占用约 90%
# 超过此数量时，最老的会话将被自动清理（LRU淘汰）
MAX_AUTH_SESSIONS=1000

# 会话过期时间（秒）
# 会话创建后超过此时间将被自动清理
# 默认 600 秒 = 10 分钟
SESSION_TTL_SECONDS=600

# ============ 配额监控配置 ============

# 配额预警阈值（0.0-1.0）
# 当账号使用率达到此比例时发出预警
QUOTA_WARNING_THRESHOLD="0.8"

# 配额严重预警阈值（0.0-1.0）
# 当账号使用率达到此比例时发出严重预警
QUOTA_CRITICAL_THRESHOLD="0.95"

# 自动禁用缺少凭据的账号（clientId/clientSecret/refreshToken）
# 默认 false，仅跳过这些账号；设置为 true 时会自动将其标记为 disabled
AUTO_DISABLE_INCOMPLETE_ACCOUNTS="false"

# HTTP代理设置（可选）
# HTTP_PROXY="http://127.0.0.1:7890"
HTTP_PROXY=""

# CORS 跨域配置（逗号分隔的允许源列表）
# ⚠️ 生产环境必须指定具体域名，禁止留空或使用通配符！
# 示例：CORS_ORIGINS="https://yourdomain.com,https://app.yourdomain.com"
CORS_ORIGINS="http://localhost:3000,http://localhost:8000,http://127.0.0.1:3000,http://127.0.0.1:8000"

# 主服务端口
PORT=8000

# ============ 核心安全配置（生产环境必须设置）============

# 调试模式（生产环境必须设置为 false！）
DEBUG="false"

# Cookie 安全设置（默认跟随 DEBUG 相反值）
# 如果通过 HTTP 访问（如 nginx 反向代理终止 HTTPS），设置为 false
# ⚠️ 纯 HTTP 环境设置为 false 会降低安全性，请确保网络安全
# Cookie 安全设置（默认为 auto，根据请求协议自动决定 Secure 标记）
# 可选值：true / false / auto
SECURE_COOKIE="auto"

# 管理控制台开关
ENABLE_CONSOLE="true"

# 管理控制台 API Key（必须设置！）
# 生成命令: openssl rand -hex 32
ADMIN_API_KEY=""

# 管理控制台登录密码（必须设置！）
# 建议使用强密码（至少16位，包含大小写字母、数字和特殊字符）
ADMIN_PASSWORD=""

# ============ 高级安全配置 ============

# JWT密钥（用于会话管理，生产环境必须设置）
# 生成命令: openssl rand -hex 64
JWT_SECRET=""

# 会话超时时间（分钟）
SESSION_TIMEOUT_MINUTES="30"

# API请求速率限制（每分钟最大请求数）
RATE_LIMIT_PER_MINUTE="300"

# 最大请求大小（MB）
MAX_REQUEST_SIZE_MB="100"

# 启用请求日志记录
ENABLE_REQUEST_LOGGING="true"

# 管理员IP白名单（可选，逗号分隔）
# 如果设置，只允许这些IP访问管理控制台
# SECURITY_LEVEL=production/military 时，如果留空则只允许 localhost 访问管理接口
# 示例：ADMIN_IP_WHITELIST="192.168.1.100,10.0.0.0/24"
ADMIN_IP_WHITELIST=""

# 动态白名单有效期（秒），管理员成功登录后自动临时信任该IP
# 例如 86400 表示 1 天，设置为 0 可禁用该功能
ADMIN_IP_AUTO_WHITELIST_TTL="86400"

# 速率限制IP白名单（可选，逗号分隔）
# 白名单中的IP将不受任何速率限制（慎用）
# 支持单个IP和CIDR网段格式
# 示例：RATE_LIMIT_IP_WHITELIST="192.168.1.100,10.0.0.0/24"
RATE_LIMIT_IP_WHITELIST=""

# ============ 数据库安全配置 ============
# Critical Fix (2026-01-12): 添加超时保护防止连接池耗尽

# 数据库连接池大小
DB_POOL_MIN_SIZE="5"
DB_POOL_MAX_SIZE="20"

# 数据库操作超时时间（秒）
# 适用于所有数据库操作（查询、连接获取等）
# 默认 30 秒，生产环境建议不超过 60 秒
DATABASE_TIMEOUT="30.0"

# 数据库连接超时（秒）- 仅用于建立连接
DB_CONNECTION_TIMEOUT="30"

# SQLite 最大连接数（使用 Semaphore 限制）
# 默认 10，避免 "database is locked" 错误
# 如果并发较高可适当增加（如 20），但不建议超过 50
SQLITE_MAX_CONNECTIONS=10

# ============ 监控和日志配置 ============

# 日志级别 (DEBUG, INFO, WARNING, ERROR, CRITICAL)
LOG_LEVEL="INFO"

# 日志文件路径（可选）
LOG_FILE_PATH="/var/log/q2api/app.log"

# 启用性能监控
ENABLE_PERFORMANCE_MONITORING="true"

# 健康检查间隔（秒）
HEALTH_CHECK_INTERVAL="60"

# ============ SSL/TLS 配置（如果直接使用HTTPS） ============

# SSL证书路径（如果使用自签名证书）
# SSL_CERT_PATH="/path/to/cert.pem"
# SSL_KEY_PATH="/path/to/key.pem"

# 强制HTTPS重定向
FORCE_HTTPS="true"

# ============ 备份配置 ============

# 自动备份间隔（小时）
BACKUP_INTERVAL_HOURS="24"

# 备份保留天数
BACKUP_RETENTION_DAYS="30"

# 备份存储路径
BACKUP_PATH="/var/backups/q2api"
